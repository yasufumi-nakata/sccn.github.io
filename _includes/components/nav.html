{%- comment -%}
  Override of just-the-docs components/nav.html
  Display labels prefer nav_title while preserving title-based hierarchy links.
{%- endcomment -%}

{%- assign nav_pages = include.pages
    | where_exp: "item", "item.title != nil"
    | where_exp: "item", "item.nav_exclude != true" -%}

{%- include sorted_pages.html pages = nav_pages -%}

{%- assign first_level_pages = sorted_pages
    | where_exp: "item", "item.parent == nil" -%}
{%- assign second_level_pages = sorted_pages
    | where_exp: "item", "item.parent != nil"
    | where_exp: "item", "item.grand_parent == nil" -%}
{%- assign third_level_pages = sorted_pages
    | where_exp: "item", "item.grand_parent != nil" -%}

<ul class="nav-list">
{%- for node in first_level_pages -%}
  {%- assign node_label = node.nav_title | default: node.long_title | default: node.title -%}
  <li class="nav-list-item">
    {%- if node.has_children -%}
    <button class="nav-list-expander btn-reset" aria-label="toggle items in {{ node_label }} category" aria-pressed="false">
      <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
    </button>
    {%- endif -%}
    <a href="{{ node.url | relative_url }}" class="nav-list-link">{{ node_label }}</a>
    {%- if node.has_children -%}
      {%- assign children_list = second_level_pages
            | where: "parent", node.title -%}
      {%- if node.child_nav_order == 'desc' or node.child_nav_order == 'reversed' -%}
        {%- assign children_list = children_list | reverse -%}
      {%- endif -%}
      <ul class="nav-list">
      {%- for child in children_list -%}
        {%- assign child_label = child.nav_title | default: child.long_title | default: child.title -%}
        <li class="nav-list-item">
          {%- if child.has_children -%}
          <button class="nav-list-expander btn-reset" aria-label="toggle items in {{ child_label }} category" aria-pressed="false">
            <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg>
          </button>
          {%- endif -%}
          <a href="{{ child.url | relative_url }}" class="nav-list-link">{{ child_label }}</a>
          {%- if child.has_children -%}
            {%- assign grand_children_list = third_level_pages
                  | where: "parent", child.title
                  | where: "grand_parent", node.title -%}
            {%- if child.child_nav_order == 'desc' or child.child_nav_order == 'reversed' -%}
              {%- assign grand_children_list = grand_children_list | reverse -%}
            {%- endif -%}
            <ul class="nav-list">
            {%- for grand_child in grand_children_list -%}
              {%- assign grand_child_label = grand_child.nav_title | default: grand_child.long_title | default: grand_child.title -%}
              <li class="nav-list-item">
                <a href="{{ grand_child.url | relative_url }}" class="nav-list-link">{{ grand_child_label }}</a>
              </li>
            {%- endfor -%}
            </ul>
          {%- endif -%}
        </li>
      {%- endfor -%}
      </ul>
    {%- endif -%}
  </li>
{%- endfor -%}
</ul>
